--CREATE OR REPLACE TABLE `[ProjectName].events_expanded`
--PARTITION BY date 
--CLUSTER BY
--  app_info_app_version
--AS
SELECT
  event_name,
  DATE(PARSE_DATETIME("%Y%m%d", (event_date)))                                                        AS date,
  CASE WHEN lower(device.operating_system) = 'android' 
       THEN "Android"
       WHEN lower(device.operating_system) = 'ios'
       THEN "iOS" 
       ELSE device.operating_system                                                            END    AS platform,
  app_info.version                                                                                    AS app_info_app_version,
  app_info.id                                                                                         AS app_info_id,
  app_info.firebase_app_id                                                                            AS app_info_firebase_app_id,
  app_info.install_source                                                                             AS app_info_install_source,
  REGEXP_REPLACE(device.operating_system_version,'[^0-9 .]','')                                       AS os_version,
  CASE WHEN device.mobile_model_name IS NOT NULL 
       THEN device.mobile_model_name 
       ELSE "unknown"                                                                             END AS device_model,
  user_pseudo_id,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='correlationId')                    AS event_params_correlationId,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='debug_event')                      AS event_params_debug_event,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='engaged_session_event')            AS event_params_engaged_session_event,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='error_value')                      AS event_params_error_value,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='firebase_error')                   AS event_params_firebase_error,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='firebase_event_origin')            AS event_params_firebase_event_origin,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='firebase_screen')                  AS event_params_firebase_screen,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='firebase_screen_class')            AS event_params_firebase_screen_class,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='firebase_screen_id')               AS event_params_firebase_screen_id,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='ga_session_id')                    AS event_params_ga_session_id,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='ga_session_number')                AS event_params_ga_session_number,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='value')                            AS event_params_value,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='engagement_time_msec')             AS event_params_engagement_time_msec, 
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='fatal')                            AS event_params_fatal,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='session_engaged')                  AS event_params_session_engaged,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='session_timestamp')                AS event_params_timestamp,  
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='previous_app_version')             AS event_params_previous_app_version,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='campaign')                         AS event_params_campaign,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='dynamic_link_accept_time')         AS event_params_dynamic_link_accept_time,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='dynamic_link_link_id')             AS event_params_dynamic_link_link_id,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='dynamic_link_link_name')           AS event_params_dynamic_link_link_name,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='medium')                           AS event_params_medium,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='source')                           AS event_params_source,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='appState')                         AS event_params_appState,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='latestWeeklyEditionError')         AS event_params_latestWeeklyEditionError,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='latestWeeklyEditionId')            AS event_params_latestWeeklyEditionId,   
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='networkSpeed')                     AS event_params_networkSpeed,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='requestedEditionId')               AS event_params_requestedEditionId,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='campaign_id')                      AS event_params_campaign_id,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='campaign_info_source')             AS event_params_campaign_info_source,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='click_timestamp')                  AS event_params_click_timestamp,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='dclid')                            AS event_params_dclid,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='term')                             AS event_params_term,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='system_app')                       AS event_params_system_app,  
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='system_app_update')                AS event_params_system_app_update, 
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='update_with_analytics')            AS event_params_update_with_analytics,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='currency')                         AS event_params_currency,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='firebase_conversion')              AS event_params_firebase_conversion,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='free_trial')                       AS event_params_free_trial,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='ga_dedupe_id')                     AS event_params_ga_dedupe_id,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='original_price')                   AS event_params_original_price,
 (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='price')                            AS event_params_price,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='price_is_discounted')              AS event_params_price_is_discounted,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='product_id')                       AS event_params_product_id,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='product_name')                     AS event_params_product_name,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='quantity')                         AS event_params_quantity,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='subscription')                     AS event_params_subscription,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='validated')                        AS event_params_validated,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='settings')                         AS event_params_settings,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='status')                           AS event_params_status,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='message_device_time')              AS event_params_message_device_time,  
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='message_name')                     AS event_params_message_name,  
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='message_time')                     AS event_params_message_time,  
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='topic')                            AS event_params_topic,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='previous_os_version')              AS event_params_previous_os_version,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='ads_enabled')                      AS event_params_ads_enabled,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='article_page_banner_enabled')      AS event_params_article_page_banner_enabled,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='article_slim_images_enabled')      AS event_params_article_slim_images_enabled,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='btn_week_sections_placement')      AS event_params_btn_week_sections_placement,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='cloudflare_acceleration_enabled')  AS event_params_cloudflare_acceleration_enabled,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='cloudflare_enabled')               AS event_params_cloudflare_enabled,
  (SELECT value.double_value FROM UNNEST(event_params) WHERE key ='content_cards_enabled')            AS event_params_content_cards_enabled,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='continue_reading_enabled')         AS event_params_continue_reading_enabled,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='cross_entitlement_enabled')        AS event_params_cross_entitlement_enabled,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='daily_picks_banner_enabled')       AS event_params_daily_picks_banner_enabled,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='daily_picks_podcast')              AS event_params_daily_picks_podcast,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='economist_today_enabled')          AS event_params_economist_today_enabled,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='enable_interactives')              AS event_params_enable_interactives,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='espresso_switch_position')         AS event_params_espresso_switch_position,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='fcx_grace_period')                 AS event_params_fcx_grace_period,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='fcx_login_enabled')                AS event_params_fcx_login_enabled,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='free_trial_countries')             AS event_params_free_trial_countries,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='free_trial_paywall')               AS event_params_free_trial_paywall,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='fullscreen_ad_enabled')            AS event_params_fullscreen_ad_enabled,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='hide_nested_related_articles')     AS event_params_hide_nested_related_articles,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='image_resize_service_enabled')     AS event_params_image_resize_service_enabled,
  (SELECT value.string_value FROM UNNEST(event_params) WHERE key ='salesforce_url')                   AS event_params_salesforce_url,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='snowplow_enabled')                 AS event_params_snowplow_enabled,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='success')                          AS event_params_success,
  (SELECT value.int_value    FROM UNNEST(event_params) WHERE key ='freeride')                         AS event_params_freeride,
  geo.continent                                                                                       AS geo_continent,
  geo.country                                                                                         AS geo_country,
  geo.region                                                                                          AS geo_region,
  geo.city                                                                                            AS geo_city,
  geo.sub_continent                                                                                   AS geo_sub_continent,
  geo.metro                                                                                           AS geo_metro,
  (SELECT value.string_value FROM UNNEST(user_properties) WHERE key ='SESSION_ID')                    AS user_properties_SESSION_ID,
  (SELECT value.string_value FROM UNNEST(user_properties) WHERE key ='SUBSCRIBER_TYPE')               AS user_properties_SUBSCRIBER_TYPE,
  (SELECT value.int_value    FROM UNNEST(user_properties) WHERE key ='ga_session_number')             AS user_properties_ga_session_number,
  (SELECT value.int_value    FROM UNNEST(user_properties) WHERE key ='first_open_time')               AS user_properties_first_open_time,
  (SELECT value.int_value    FROM UNNEST(user_properties) WHERE key ='ga_session_id')                 AS user_properties_ga_session_id,
  (SELECT value.string_value FROM UNNEST(user_properties) WHERE key ='PUBLICATION_REGION')            AS user_properties_PUBLICATION_REGION,
  device.category                                                                                     AS device_category,
  device.mobile_brand_name                                                                            AS device_mobile_brand_name,
  device.mobile_model_name                                                                            AS device_mobile_model_name,
  device.mobile_marketing_name                                                                        AS device_mobile_marketing_name,
  device.mobile_os_hardware_model                                                                     AS device_mobile_os_hardware_model,
  device.operating_system_version                                                                     AS device_operating_system_version,
  device.advertising_id                                                                               AS device_advertising_id,
  device.language                                                                                     AS device_language,
  device.is_limited_ad_tracking                                                                       AS device_is_limited_ad_tracking,
  device.time_zone_offset_seconds                                                                     AS device_time_zone_offset_seconds,
  privacy_info.analytics_storage                                                                      AS privacy_info_analytics_storage,
  privacy_info.ads_storage                                                                            AS privacy_info_ads_storage,
  privacy_info.uses_transient_token                                                                   AS privacy_info_uses_transient_token
FROM `[ProjectName].[Table].events_*`
--WHERE 
--CAST(regexp_extract(app_info.version, r'([0-9]+)\.[0-9]+\.[0-9]+') AS int64) >= 3 
--AND CAST(regexp_extract(app_info.version, r'\.([0-9]+)\.[0-9]+') AS int64) >= 3
--AND _table_suffix >= "20220120"
